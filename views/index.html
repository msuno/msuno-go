<!DOCTYPE html>

<html>
<head>
  <title>API TEST</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <link rel="shortcut icon" href="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/4QAiRXhpZgAATU0AKgAAAAgAAQESAAMAAAABAAEAAAAAAAD/2wBDAAIBAQIBAQICAgICAgICAwUDAwMDAwYEBAMFBwYHBwcGBwcICQsJCAgKCAcHCg0KCgsMDAwMBwkODw0MDgsMDAz/2wBDAQICAgMDAwYDAwYMCAcIDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAz/wAARCAAgACADASIAAhEBAxEB/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9oADAMBAAIRAxEAPwD6y07S/tG1v8k1v6l4vl/Z+0q38Rat4Rk8TeE3YC8ltUVrnSpBnEjK/wC7aMjoWZNrAgt8yimaP9nsrWS5upY7e1tYjNLLICUjVRksQoJwPYE+leCw/Fb4sftNRa1L4RvNW0fTdPf+y545tfWx0vTftAwguJ02bogrMXkCNKIkfIYYDfdeJHEc8Fho4HCc3t6l3FRSekd3JS05ejvbfRq11+K5Ph3UqOo+mxj+F/hH4d+Kn7XviDxB4P0HUNI+HesSNZ2tvaulhdSzT24tY7G2jOGglupmn8ottjtw/nFxFBtOD+158ALHwxd+O76x8PWGjah4Av7XU7m/0WyZLC1v7cpIp3bCYLWQwPDDExQRoYlDMYyW81s9e+L37PHia+k+EureKvEOoXBvrufToNLa9trqJYEjmuriz/eRvG5O3Y6sIfs0e0jbGa0vhd/wWF8TfAHU/GEl/a6b46vvH1jGl9reoE3UllIi7AHRMRTZimbdE+CWxnKhkP8AM8cTQxGGo0leDlUlUlKMVZtQbSS00TaSjpZbu+p9TSxVJRVNp3u7vv8A12PuaxtbXVbZYbq2tbyEkHy54lkQkdDhgRXlviX9niO48U6pqunaeuj6Lr087XdnaqIYbl47NvKmliAwBmFMZwRuYDG87u80DVg6r9K7jwhfR3Mm2XaytwQ3IYd81/WPG3BeFzyjGGJk4qLvpbV2tZu12rN6XV736I+Jy7GSozdludf+yN8BtH+DPgu4t1t4rq4161hGoJeW6SbRszJbZIybfezN5TZAZnJzuwPyu/4KlfsqWPwZ8U61oPw/+G19oPhubW7q7fxALa5t9LbzQrLZQyMfs3lWwDbzEpYOSrEFMH9eNC15YIVO4A9zmtyHxsF3bJmXcvlttb7y+hHp7V+fZxwThqmFhg8L7ns/hdr/AHq6vffc+vw9SNWmozZ//9k=" type="image/x-icon" />
  <link rel="stylesheet" href="/static/css/prism.css"/>
  <style type="text/css">
    *,body { margin: 0px; padding: 0px;}
    .backdrop { position: relative; width: 100%; height: 100vh; box-shadow: inset 0px 0px 100px #ddd; display: flex; flex-direction: row; }
    pre {outline: 1px solid #ccc; margin: 1vh; padding: 2vh 2vh 2vh 5vh; min-height: 25vh; height: auto; word-wrap: break-word;word-break: break-all; background: #f8f8f8; color: #b299a5; font-size: 16px; }
    .string { color: #669900; }
    .number { color: #990055; }
    .boolean { color: #7acb76; }
    .null { color: magenta; }
    .key { color: #990055; }
    .tab{ height: 30px;}
    .left {overflow-y: auto; height: 100%; width: 360px; flex-shrink: 0; background: #eaeaeb; }
    .right{ overflow-y: auto; width: 100%; }
    .left_h3 {text-align: center; margin-top: 20px; height: auto;}
    .row {width: 330px;margin: 5px auto 5px auto;height: auto;word-wrap: break-word;word-break: break-all;overflow: hidden; padding: 5px;}
    .row:hover {border: 1px solid #dbdbdb; cursor: pointer;}
    .row-span{background: aquamarine; margin: auto 5px auto 5px; padding-left: 5px; padding-right: 5px;}
    .table{ padding: 10px 0px 10px 0px; margin: 10px 0px 5px 20px; display: flex; flex-direction: row; width: 95%; height: auto;}
	.show{ padding: 10px 0px 10px 0px; margin: 10px 0px 5px 20px; flex-direction: row; width: 95%; height: auto;}
    .table>label {height: auto;padding-top: 5px; margin-right: 5px;margin-left: 10px;}
    .input-url { border-bottom: 1px solid #dbdbdb; border-top: 0px; border-left: 0px; border-right: 0px; background: transparent; width: 80%; height: 30px; margin-right: 30px;}
    .input-line { border-bottom: 1px solid #dbdbdb; border-top: 0px; border-left: 0px; border-right: 0px; background: transparent; height: 30px; margin-right: 10px; }
    button.input-line { width: 100px; margin-right: 10px; }
    .table>label>input{height: 10px; margin-left: 20px;}
    .toAg{width:20px;height: 20px;background-color: #7acb76;position:absolute;left:360px;top:90vh;}
    .sbig{cursor: pointer}
    .sbig:hover {color: blue}
	#rightMenu{list-style: none;background: gainsboro;border: solid 1px darkgrey;margin: 0px;padding: 5px;position: absolute;top: 0px;}
	#rightMenu>li{cursor: pointer;text-align: center;}
  </style>
</head>

<body>
    <div class="description backdrop" id="app">
      <div class="left" id="left" ref="leftBox" v-if="show">
        <h3 class="left_h3">历史记录</h3>
        <div class="row" v-for="h in history" :id="h.id" @click="setHistory(h)" @contextmenu.prevent="menuBtn($event)"><span class="row-span">{{h.method}}</span>{{h.url}}</div>
      </div>
      <div class="toAg" @click="toAg($event)"></div>
      <div class="right">
        <div class="table" v-if="selectBtn == '0'">
          <label>appId：</label><input id="appId" name="appId" v-model="conf.appId" class="input-line" style="width: 70px;" placeholder="appId"/>
          <label>userId：</label><input id="userId" name="userId" v-model="conf.userId" class="input-line" style="width: 80px;" placeholder="userId"/>
          <label>appSecret：</label><input id="appSecret" name="appSecret" v-model="conf.appSecret" class="input-line" style="width: 300px;" placeholder="appSecret"/>
          <button class="input-line" @click="save" style="width: 90px;">保存</button>
        </div>
        <div class="table" v-else>
          <label>用户名：</label><input id="appId" name="appId" v-model="conf.appId" class="input-line" style="width: 70px;" placeholder="USERNAME"/>
          <label>密&nbsp;&nbsp;码：</label><input id="userId" name="userId" v-model="conf.userId" class="input-line" style="width: 80px;" placeholder="PASSWORD"/>
          <label>appSecret：</label><input id="appSecret" name="appSecret" v-model="conf.appSecret" class="input-line" style="width: 300px;" placeholder="URL"/>
          <button class="input-line" @click="save" style="width: 90px;">保存</button>
        </div>
        <div class="table">
          <input id="url" name="url" v-model="need.url" class="input-url" placeholder="url"/>
          <select class="input-url" id="method" name="method" style="width: 90px" v-model="need.method">
            <option value="GET">GET</option>
            <option value="POST">POST</option>
          </select>
          <select class="input-url" id="type" name="type" style="width: 90px" v-model="need.type">
            <option value="0">FALSE</option>
            <option value="1">TRUE</option>
          </select>
          <button class="input-line" @click="delParam">删除</button>
          <button class="input-line" @click="addParam">添加</button>
        </div>
        <div class="table" v-for="item,index in reqParams">
          <input :id="'key'+index" class="input-line" placeholder="key" v-model="item[0]"/>
          <input :id="'val'+index" class="input-line" placeholder="value" v-model="item[1]"/>
        </div>
        <div class="table">
          <button class="input-line" @click="reqData">提交</button><button class="input-line" @click="clearBtn">清空</button>
          <label>耗时：{{execTime}}纳秒</label>
          <label>api
            <input class="input-line" type="radio" v-model="selectBtn" value="0" name="redio">
          </label>
          <label>ps
            <input class="input-line" type="radio" v-model="selectBtn" value="1" name="redio">
          </label>
        </div>
		<div class="show">
		  <pre class="line-numbers"><code class="language-json" v-html="reqJson"></code></pre>
		</div>
        <div class="show">

          <pre class="line-numbers"><p class="sbig" @click="sBig">放大</p><code class="language-json" v-html="content"></code></pre>
        </div>
      </div>
	  <ul id="rightMenu" v-show="menu" style="width: 100px;">
        <li><div @click="del">删除</div></li>
	  </ul>
    </div>

  <script type="text/javascript" src="/static/js/jquery-3.4.1.min.js"></script>
  <script type="text/javascript" src="/static/js/md5.min.js"></script>
  <script type="text/javascript" src="/static/js/vue.min.js"></script>
  <script>
    new Vue({
      el: "#app",
      data: {
        conf: {appId:"fbixrsybs6",userId:"ee7fe7fbda",appSecret:"019328f5e5f14f24a0e8d3403bac8f17"},
        need: {url:"",method:"POST",type:"0"},
        selectBtn: "0",
        count: 0,
        content: '',
        history: '',
        page: '',
        reqParams:[],
        reqJson:'',
        execTime: '',
        show: true,
        hId: '',
		dId: 0,
		menu: false
      },
      methods: {
        save(){
          $.post("/conf/save", this.conf, res => {
            alert(res.status)
          })
        },
        addParam(){
          this.count ++
          this.reqParams.push(["",""])
        },
        delParam(){
          if(this.count == 0)
            return
          this.count --
          this.reqParams.pop()
        },
        reqData(){
          var params = {}
          if(this.selectBtn === "0") {
            params["appId"] = this.conf.appId
            params["timestamp"] = new Date().getTime()
          }else{
            alert("敬请期待！")
            return
          }
          for(var a of this.reqParams){
            if(a[0] != '' & a[1] != ''){
              params[a[0]] = a[1]
            }
          }
          if(this.selectBtn === "0") {
            params["sign"] = this.sign(params, this.conf.appSecret)
          }
          this.send(params)
        },
        sign(obj,appSecret) {
          var res = Object.keys(obj)
                  .sort((a, b) => a.toLocaleLowerCase().charCodeAt(0) - b.toLocaleLowerCase().charCodeAt(0))
                  .reduce((str, key) => {
                    let value = obj[key].toString();
                    return `${str}${key}${value}`;},appSecret)
          return md5.hex(`${res}${appSecret}`).toUpperCase()
        },
        send(req){
          var data = $.extend(true,{},req)
          data["url"] = this.need.url
          data["method"] = this.need.method
          data["isSave"] = this.need.type
          $.ajax({
            type: "POST",
            url: "/send",
            data: data,
            success: res => {
              if(res.code === 0) {
                this.content = this.syntaxHighlight(res.data)
              }else{
                this.content = this.syntaxHighlight(res)
              }
              if(this.need.type === "1"){
                this.refresh()
              }
              this.execTime = res.exec
              this.need.type = 0
            },
            error: res => {
              this.content = this.syntaxHighlight(res)
            }
          })
        },
        syntaxHighlight(json) {
          if (typeof json != 'string') {
            json = JSON.stringify(json, undefined, 4);
          }
          json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
          return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function(match) {
            var cls = 'number';
            if (/^"/.test(match)) {
              if (/:$/.test(match)) {
                cls = 'key';
              } else {
                cls = 'string';
              }
            } else if (/true|false/.test(match)) {
              cls = 'boolean';
            } else if (/null/.test(match)) {
              cls = 'null';
            }
            return '<span class="' + cls + '">' + match + '</span>';
          });
        },
        setHistory(res){
          this.need.url = res.url
          this.need.method = res.method
          this.execTime = res.exec
          this.content = (!res.result || res.result == "") ? {} : this.syntaxHighlight(eval('(' + res.result + ')'))
          var obj = eval('(' + res.param + ')')
          this.reqJson = this.syntaxHighlight(obj)
          delete obj.appId; delete obj.sign; delete obj.timestamp;
          this.reqParams = []
          this.count = 0
          for(var key in obj){
            this.count ++
            this.reqParams.push([key,obj[key]])
          }
          this.hId = res.id
        },
        refresh(){
          $.post("/history/query",{page:1, pageSize:20}, res => {
            if(res.code === 0){
              this.history = res.data.data
              this.page = res.data
              this.setHistory(this.history[0])
            }
          });
        },
        clearBtn(){
          this.count = 0;
          this.need = {url:"",method:"POST",type:"0"};
          this.reqParams = [];
        },
        watchParam(){
          var data = {}
          data["url"] = this.need.url
          data["method"] = this.need.method
          data["isSave"] = this.need.type
          var js = {}
          for(var a of this.reqParams){
            js[a[0]] = a[1]
          }
          js["appId"] = this.conf.appId
          js["userId"] = this.conf.userId
          js["appSecret"] = this.conf.appSecret
		  js["timestamp"] = new Date().getTime();
          data["params"] = js
          this.reqJson = this.syntaxHighlight(data)
        },
        toAg(e){
          this.show = !this.show
          if(!this.show){
            e.target.style.left = "0px"
          }else{
            e.target.style.left = "360px"
          }
        },
        sBig(){
          window.open('/json?id='+this.hId, '_black')
        },
        menuBtn(e){
          var y = e.clientY;
		  var x = e.clientX;
		  $("#rightMenu").css("left",x).css("top",y);
		  this.menu = true;
		  this.dId = $(e.target).attr("id");
		  console.log(this.dId)
		},
		del(){
          this.menu = false;
		   $.post("/history/delete",{id: this.dId},(data)=>{
		     this.refresh();
           })
		}
      },
      watch:{
        reqParams(obj){
          this.watchParam()
        },
        'need.url'(obj){
          this.watchParam()
        },
        'need.method'(obj){
          this.watchParam()
        },
        'need.type'(obj){
          this.watchParam()
        }
      },
      mounted(){
        var that = this
         $("#left").scroll(function () {
           if($(this)[0].scrollTop + $(window).height() == $(this)[0].scrollHeight - 1){
             if(that.page.page < that.page.totalPage){
               $.post("/history/query",{page:that.page.page + 1,pageSize:that.page.pageSize},function (res) {
                  if(res.code == 0){
                    that.page = res.data
                    for(var a of res.data.data){
                      that.history.push(a)
                    }
                  }
               })
             }
           }
         })
      },
      created(){
        $.post("/conf/fetch", {}, res => {
          if(res.code === 0){
            this.conf = res.data
          }
        });
       this.refresh()
      }
    })
  </script>
</body>
</html>
